<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Latent Class Regression Tool - Setup</title>
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --success: #16a34a;
            --danger: #dc2626;
            --warning: #f59e0b;
            --bg: #f8fafc;
            --card-bg: #ffffff;
            --text-dark: #1e293b;
            --text-light: #64748b;
            --border: #e2e8f0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--bg);
            color: var(--text-dark);
            line-height: 1.6;
            padding: 2rem;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 0.5rem;
            color: var(--text-dark);
        }

        .subtitle {
            text-align: center;
            color: var(--text-light);
            margin-bottom: 2rem;
        }

        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text-dark);
        }

        /* Disclaimer */
        .disclaimer {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            font-size: 0.9rem;
        }

        .disclaimer-title {
            font-weight: 600;
            color: #92400e;
            margin-bottom: 0.5rem;
        }

        .disclaimer ul {
            margin-left: 1.25rem;
            color: #78350f;
        }

        .disclaimer li {
            margin-bottom: 0.25rem;
        }

        /* Requirements */
        .requirements {
            background: #dbeafe;
            border: 1px solid #3b82f6;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .requirements-title {
            font-weight: 600;
            color: #1e40af;
            margin-bottom: 0.5rem;
        }

        .requirements ul {
            margin-left: 1.25rem;
            color: #1e3a8a;
        }

        /* Steps */
        .step {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--border);
        }

        .step:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .step-number {
            flex-shrink: 0;
            width: 36px;
            height: 36px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .step-content {
            flex: 1;
        }

        .step-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-dark);
        }

        .step-description {
            color: var(--text-light);
            font-size: 0.95rem;
        }

        /* Code block */
        .code-block {
            background: #1e293b;
            color: #e2e8f0;
            padding: 1rem;
            border-radius: 8px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.9rem;
            overflow-x: auto;
            margin: 0.75rem 0;
        }

        .code-block code {
            color: #4ade80;
        }

        /* Links */
        a {
            color: var(--primary);
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        /* Download button */
        .btn {
            display: inline-block;
            padding: 0.75rem 1.5rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            text-decoration: none;
            margin-top: 0.5rem;
        }

        .btn:hover {
            background: var(--primary-dark);
            text-decoration: none;
        }

        /* Features list */
        .features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .feature {
            background: var(--bg);
            padding: 1rem;
            border-radius: 8px;
        }

        .feature-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
            color: var(--text-dark);
        }

        .feature-desc {
            font-size: 0.85rem;
            color: var(--text-light);
        }

        /* Mobile Responsiveness */
        @media (max-width: 640px) {
            body { padding: 1rem; }
            h1 { font-size: 1.5rem; }
            .subtitle { font-size: 0.9rem; }
            .card { padding: 1rem; }
            .step { flex-direction: column; gap: 0.75rem; }
            .step-number { width: 32px; height: 32px; font-size: 0.9rem; }
            .btn { width: 100%; text-align: center; }
            .code-block { font-size: 0.8rem; padding: 0.75rem; }
        }
    </style>
</head>
<body>
<!-- Auth check -->
<div id="loading-screen" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: white; display: flex; align-items: center; justify-content: center; z-index: 9999;">
    <p style="color: #64748b;">Loading...</p>
</div>
<div id="main-content" style="display: none;">
    <div style="max-width: 800px; margin: 0 auto; padding: 0 0 10px 0;">
        <a href="tools.html" style="display: inline-flex; align-items: center; gap: 6px; color: #64748b; text-decoration: none; font-size: 0.9rem; font-weight: 500;">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
            Back to Pricing & Analytics Tools
        </a>
    </div>
    <div class="container">
        <h1>Latent Class Regression Tool</h1>
        <p class="subtitle">Estimate segment-level regression models using the flexmix package</p>

        <!-- Disclaimer -->
        <div class="disclaimer">
            <div class="disclaimer-title">Disclaimer</div>
            <ul>
                <li><strong>Results may contain errors.</strong> The output from this tool may be inaccurate, incomplete, or incorrect. Users should independently verify all results before relying on them.</li>
                <li><strong>No warranty.</strong> This tool is provided "as is" without any warranty of any kind.</li>
                <li><strong>User assumes all risk.</strong> Users assume full and complete responsibility for reviewing, validating, and determining suitability of any output.</li>
            </ul>
        </div>

        <!-- Requirements -->
        <div class="requirements">
            <div class="requirements-title">Requirements</div>
            <ul>
                <li><strong>R</strong> - Statistical programming language (<a href="https://cran.r-project.org/" target="_blank">Download R</a>)</li>
                <li><strong>RStudio</strong> - IDE for R (<a href="https://posit.co/download/rstudio-desktop/" target="_blank">Download RStudio</a>)</li>
            </ul>
        </div>

        <!-- Setup Instructions -->
        <div class="card">
            <div class="card-title">Setup Instructions</div>

            <div class="step">
                <div class="step-number">1</div>
                <div class="step-content">
                    <div class="step-title">Install R and RStudio</div>
                    <div class="step-description">
                        If you don't have R and RStudio installed, download and install them from the links above. Install R first, then RStudio.
                    </div>
                </div>
            </div>

            <div class="step">
                <div class="step-number">2</div>
                <div class="step-content">
                    <div class="step-title">Download and Open the App</div>
                    <div class="step-description">
                        Download the app file and open it in RStudio:
                    </div>
                    <button class="btn" id="downloadBtn">Download Latent_Class_Regression.R</button>
                    <div class="step-description" style="margin-top: 0.75rem;">
                        In RStudio: File → Open File → Select the downloaded <code>Latent_Class_Regression.R</code>
                    </div>
                </div>
            </div>

            <div class="step">
                <div class="step-number">3</div>
                <div class="step-content">
                    <div class="step-title">Run the App</div>
                    <div class="step-description">
                        With <code>Latent_Class_Regression.R</code> open in RStudio, click the <strong>"Run App"</strong> button in the top-right corner of the editor panel. The app will open in a new window or your web browser.
                    </div>
                    <div class="step-description" style="margin-top: 0.5rem;">
                        <strong>Note:</strong> On first run, the app will automatically install the required R packages (<code>shiny</code> and <code>flexmix</code>). This may take a minute.
                    </div>
                    <div class="step-description" style="margin-top: 0.5rem;">
                        <strong>Tip:</strong> To open in fullscreen/external browser, click the "Open in Browser" button in the app window, or use the dropdown next to "Run App" and select "Run External".
                    </div>
                </div>
            </div>
        </div>

        <!-- Features -->
        <div class="card">
            <div class="card-title">Features</div>
            <div class="features">
                <div class="feature">
                    <div class="feature-title">CSV Data Upload</div>
                    <div class="feature-desc">Upload your dataset in CSV format</div>
                </div>
                <div class="feature">
                    <div class="feature-title">Three Model Types</div>
                    <div class="feature-desc">Linear, Poisson, or Binary Logistic regression</div>
                </div>
                <div class="feature">
                    <div class="feature-title">Segment Selection</div>
                    <div class="feature-desc">Specify the number of latent segments (1-10)</div>
                </div>
                <div class="feature">
                    <div class="feature-title">Consumer/HH ID Grouping</div>
                    <div class="feature-desc">Cluster observations by Consumer or Household ID</div>
                </div>
                <div class="feature">
                    <div class="feature-title">Segment Estimates</div>
                    <div class="feature-desc">View coefficients, std. errors, and p-values for each segment</div>
                </div>
                <div class="feature">
                    <div class="feature-title">Model Fit Statistics</div>
                    <div class="feature-desc">AIC, BIC, and segment sizes (prior probabilities)</div>
                </div>
            </div>
        </div>

        <!-- Troubleshooting -->
        <div class="card">
            <div class="card-title">Troubleshooting</div>

            <div style="margin-bottom: 1rem;">
                <strong>App doesn't open</strong>
                <div class="step-description">Make sure you have the <code>Latent_Class_Regression.R</code> file open in RStudio's editor (not just in the file browser), then click "Run App".</div>
            </div>

            <div style="margin-bottom: 1rem;">
                <strong>Package installation fails</strong>
                <div class="step-description">Try running these commands manually in the Console:</div>
                <div class="code-block">
<code>install.packages("shiny")</code>
<code>install.packages("flexmix")</code>
                </div>
            </div>

            <div style="margin-bottom: 1rem;">
                <strong>Model fails to converge</strong>
                <div class="step-description">Try reducing the number of segments, or check that your data has enough variation. The flexmix algorithm may need more observations per segment.</div>
            </div>

            <div>
                <strong>"Run App" button not visible</strong>
                <div class="step-description">Make sure the file is saved with a <code>.R</code> extension. RStudio only shows the "Run App" button for R files that contain Shiny code.</div>
            </div>
        </div>
    </div>

    <script>
        document.getElementById('downloadBtn').addEventListener('click', function() {
            const rCode = `# Latent Class Regression Tool - Shiny App
#
# TO RUN THIS APP:
#   1. Open this file in RStudio
#   2. Click "Run App" button (top right of editor)
#   OR run in console: shiny::runApp()
#
# TIP: To run in fullscreen/external browser, use:
#   options(shiny.launch.browser = TRUE)
#   shiny::runApp()

# Auto-install required packages if missing
if (!require("shiny", quietly = TRUE)) {
  install.packages("shiny", repos = "https://cloud.r-project.org")
}
if (!require("flexmix", quietly = TRUE)) {
  install.packages("flexmix", repos = "https://cloud.r-project.org")
}

library(shiny)
library(flexmix)

ui = fluidPage(
  # Custom CSS
  tags$head(
    tags$style(HTML("
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: #f8fafc;
        padding: 20px;
      }
      .container-fluid {
        max-width: 900px;
        margin: 0 auto;
        padding: 0 20px;
      }
      h1 {
        text-align: center;
        color: #1e293b;
        margin-bottom: 5px;
      }
      .subtitle {
        text-align: center;
        color: #64748b;
        margin-bottom: 30px;
      }
      .card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      }
      .card-title {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 15px;
        color: #1e293b;
      }
      .btn-primary {
        background: #2563eb;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
      }
      .btn-primary:hover {
        background: #1d4ed8;
      }
      .btn-success {
        background: #16a34a;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
      }
      .btn-success:hover {
        background: #15803d;
      }
      .stat-box {
        background: #f8fafc;
        border-radius: 8px;
        padding: 15px;
        text-align: center;
        margin-bottom: 10px;
      }
      .stat-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: #2563eb;
      }
      .stat-label {
        font-size: 0.85rem;
        color: #64748b;
      }
      .disclaimer {
        background: #fef3c7;
        border: 1px solid #f59e0b;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
        font-size: 0.9rem;
      }
      .disclaimer-title {
        font-weight: 600;
        color: #92400e;
        margin-bottom: 8px;
      }
      .disclaimer ul {
        margin-left: 20px;
        color: #78350f;
        margin-bottom: 0;
      }
      .table {
        font-size: 0.9rem;
      }
      .nav-tabs .nav-link.active {
        background: #2563eb;
        color: white;
        border: none;
      }
      .nav-tabs .nav-link {
        color: #64748b;
        border: none;
        border-radius: 6px;
        margin-right: 5px;
      }
      .help-text {
        font-size: 0.85rem;
        color: #64748b;
        margin-top: 5px;
      }
      .segment-header {
        background: #2563eb;
        color: white;
        padding: 10px 15px;
        border-radius: 8px 8px 0 0;
        font-weight: 600;
      }
      .segment-body {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-top: none;
        border-radius: 0 0 8px 8px;
        padding: 15px;
        margin-bottom: 15px;
      }
      .segment-size {
        font-size: 0.9rem;
        color: #64748b;
      }
      pre.r-script {
        background: #1e293b;
        color: #e2e8f0;
        padding: 15px;
        border-radius: 8px;
        font-size: 0.85rem;
        overflow-x: auto;
      }
      .form-group {
        max-width: 500px;
        margin-left: auto;
        margin-right: auto;
      }
      .shiny-input-container {
        width: 100% !important;
      }
      .center-content {
        max-width: 500px;
        margin-left: auto;
        margin-right: auto;
      }
      .data-preview {
        background: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 15px;
        margin-top: 15px;
        overflow-x: auto;
      }
      .data-preview h5 {
        margin-bottom: 10px;
        color: #1e293b;
      }
      .data-preview table {
        font-size: 0.85rem;
        width: 100%;
      }
      .btn-secondary {
        background: #64748b;
        border: none;
        padding: 8px 16px;
        border-radius: 8px;
        color: white;
      }
      .btn-secondary:hover {
        background: #475569;
      }
    "))
  ),

  # Title
  h1("Shiny App for Latent Class Regression Analysis"),
  p(class = "subtitle", "Estimate segment-level regression models using the \\"flexmix\\" package in R."),

  # Disclaimer
  div(class = "disclaimer",
    div(class = "disclaimer-title", "Disclaimer"),
    tags$ul(
      tags$li(tags$strong("Results may contain errors."), " The output from this tool may be inaccurate, incomplete, or incorrect. Users should independently verify all results."),
      tags$li(tags$strong("No warranty."), " This tool is provided \\"as is\\" without any warranty of any kind."),
      tags$li(tags$strong("User assumes all risk."), " Users assume full responsibility for reviewing and validating any output.")
    )
  ),

  # Top-to-bottom layout
  # Step 1: Data Upload
  div(class = "card",
    div(class = "card-title", "1. Upload Data"),
    div(class = "center-content",
      fileInput("file", "Choose CSV File",
        accept = c("text/csv", "text/comma-separated-values", ".csv")
      ),
      p(class = "help-text", "Upload a CSV file with headers in the first row.")
    ),
    # Data preview
    uiOutput("data_preview")
  ),

  # Model Setup (conditional)
  uiOutput("model_setup_card"),

  # Run button (conditional)
  uiOutput("run_card"),

  # Results
  uiOutput("results_card")
)

server = function(input, output, session) {

  # Reactive values
  data = reactiveVal(NULL)
  model_result = reactiveVal(NULL)

  # Load data
  observeEvent(input$file, {
    req(input$file)
    tryCatch({
      df = read.csv(input$file$datapath, stringsAsFactors = FALSE)
      data(df)
      model_result(NULL)
      showNotification(paste("Loaded", nrow(df), "rows and", ncol(df), "columns."), type = "message")
    }, error = function(e) {
      showNotification(paste("Error loading file:", e$message), type = "error")
    })
  })

  # Data preview
  output$data_preview = renderUI({
    df = data()
    if (is.null(df)) return(NULL)

    div(class = "data-preview",
      h5(paste0("Data Preview (", nrow(df), " rows, ", ncol(df), " columns)")),
      tableOutput("preview_table")
    )
  })

  # Preview table (first 10 rows)
  output$preview_table = renderTable({
    df = data()
    if (is.null(df)) return(NULL)
    head(df, 10)
  }, rownames = FALSE)

  # Model setup card
  output$model_setup_card = renderUI({
    df = data()
    if (is.null(df)) return(NULL)

    cols = names(df)

    div(class = "card",
      div(class = "card-title", "2. Model Specification"),
      div(class = "center-content",
        selectInput("dv", "Dependent Variable (Y)", choices = cols),

        selectInput("ivs", "Independent Variables (X)",
          choices = cols,
          multiple = TRUE
        ),

        selectInput("consumer_id", "Consumer/HH ID (for clustering)",
          choices = c("(None)" = "", cols),
          selected = ""
        ),
        p(class = "help-text", "Select a variable that identifies consumers or households. Leave empty if each row is independent."),

        selectInput("model_type", "Regression Type",
          choices = c(
            "Linear Regression" = "gaussian",
            "Poisson Regression" = "poisson",
            "Binary Logistic Regression" = "binomial"
          )
        ),

        numericInput("num_segments", "Number of Segments (k)",
          value = 2, min = 1, max = 10, step = 1
        ),
        p(class = "help-text", "Set k=1 for a standard (non-segmented) model."),

        numericInput("seed", "Seed Selection",
          value = 123, min = 1, step = 1
        ),
        p(class = "help-text", "For reproducibility, choose the same seed next time you run.")
      )
    )
  })

  # Run card
  output$run_card = renderUI({
    df = data()
    if (is.null(df)) return(NULL)

    div(class = "card",
      div(class = "card-title", "3. Run Model"),
      div(class = "center-content",
        actionButton("run_model", "Run Latent Class Model", class = "btn-success", style = "width: 100%;")
      )
    )
  })

  # Run model
  observeEvent(input$run_model, {
    df = data()
    req(df, input$dv, input$ivs)

    if (length(input$ivs) == 0) {
      showNotification("Please select at least one independent variable.", type = "error")
      return()
    }

    # Check if DV is in IVs
    if (input$dv %in% input$ivs) {
      showNotification("Dependent variable cannot also be an independent variable.", type = "error")
      return()
    }

    tryCatch({
      withProgress(message = "Estimating model...", {

        # Build formula
        formula_str = paste(input$dv, "~", paste(input$ivs, collapse = " + "))

        # Add consumer/HH ID if specified
        if (input$consumer_id != "") {
          formula_str = paste(formula_str, "|", input$consumer_id)
        }

        model_formula = as.formula(formula_str)

        # Set seed
        set.seed(input$seed)

        # Determine family
        if (input$model_type == "gaussian") {
          model_family = FLXMRglm(family = "gaussian")
        } else if (input$model_type == "poisson") {
          model_family = FLXMRglm(family = "poisson")
        } else {
          model_family = FLXMRglm(family = "binomial")
        }

        # Run model
        if (input$num_segments == 1) {
          # Standard GLM for k=1
          if (input$model_type == "gaussian") {
            fit = glm(as.formula(paste(input$dv, "~", paste(input$ivs, collapse = " + "))),
                      data = df, family = gaussian())
          } else if (input$model_type == "poisson") {
            fit = glm(as.formula(paste(input$dv, "~", paste(input$ivs, collapse = " + "))),
                      data = df, family = poisson())
          } else {
            fit = glm(as.formula(paste(input$dv, "~", paste(input$ivs, collapse = " + "))),
                      data = df, family = binomial())
          }

          # For k=1, create cluster assignments if consumer_id specified
          clusters_glm = NULL
          if (input$consumer_id != "") {
            unique_ids = unique(df[[input$consumer_id]])
            clusters_glm = data.frame(
              ID = unique_ids,
              Segment = rep(1, length(unique_ids))
            )
            colnames(clusters_glm) = c(input$consumer_id, "Segment")
          }

          model_result(list(
            type = "glm",
            fit = fit,
            k = 1,
            model_type = input$model_type,
            formula = formula_str,
            dv = input$dv,
            ivs = input$ivs,
            consumer_id = input$consumer_id,
            clusters = clusters_glm,
            seed = input$seed
          ))

        } else {
          # Latent class model for k > 1
          fit = stepFlexmix(
            model_formula,
            data = df,
            k = input$num_segments,
            model = model_family,
            nrep = 3
          )

          # Get actual number of segments (may be less than requested)
          actual_k = fit@k

          # Get segment assignments
          clusters = NULL
          if (input$consumer_id != "") {
            clusters = unique(cbind(df[[input$consumer_id]], clusters(fit)))
            colnames(clusters) = c(input$consumer_id, "Segment")
          }

          # Get refit model for coefficients
          refit_fit = refit(fit)

          model_result(list(
            type = "flexmix",
            fit = fit,
            refit_model = refit_fit,
            k_requested = input$num_segments,
            k = actual_k,
            model_type = input$model_type,
            formula = formula_str,
            dv = input$dv,
            ivs = input$ivs,
            consumer_id = input$consumer_id,
            clusters = clusters,
            seed = input$seed
          ))
        }

        # Check if fewer segments were identified
        result = model_result()
        if (result$type == "flexmix" && result$k < result$k_requested) {
          showNotification(
            paste0("Note: Only ", result$k, " segments could be identified (requested ", result$k_requested, "). The model converged to fewer segments."),
            type = "warning",
            duration = 10
          )
        } else {
          showNotification("Model estimated successfully!", type = "message")
        }
      })

    }, error = function(e) {
      showNotification(paste("Error:", e$message), type = "error")
    })
  })

  # Results card
  output$results_card = renderUI({
    result = model_result()
    if (is.null(result)) {
      return(
        div(class = "card",
          div(class = "card-title", "Results"),
          div(style = "text-align: center; padding: 60px; color: #64748b;",
            "Upload data and run a model to see results here."
          )
        )
      )
    }

    div(class = "card",
      div(class = "card-title", "Results"),
      tabsetPanel(
        tabPanel("Segment Estimates",
          div(style = "margin-top: 15px;",
            uiOutput("segment_estimates")
          )
        ),
        tabPanel("Segment Sizes",
          div(style = "margin-top: 15px;",
            uiOutput("segment_sizes")
          )
        ),
        if (!is.null(result$clusters)) {
          tabPanel("Consumer/HH Assignments",
            div(style = "margin-top: 15px;",
              tableOutput("consumer_assignments"),
              p(style = "font-size: 0.85rem; color: #64748b; font-style: italic;",
                if (result$k == 1) {
                  "With only one segment, all consumers/households are assigned to Segment 1."
                } else {
                  "Shows which segment each consumer/household is assigned to."
                }
              )
            )
          )
        },
        tabPanel("R Script",
          div(style = "margin-top: 15px;",
            p(style = "color: #64748b;", "Use this R script to reproduce the analysis:"),
            verbatimTextOutput("r_script"),
            downloadButton("download_script", "Download R Script", class = "btn-secondary")
          )
        )
      )
    )
  })

  # Segment estimates
  output$segment_estimates = renderUI({
    result = model_result()
    if (is.null(result)) return(NULL)

    if (result$type == "glm") {
      # Standard GLM - coefficient table first, then fit stats
      fit = result$fit
      aic_val = round(AIC(fit), 2)
      bic_val = round(BIC(fit), 2)
      ll_val = round(as.numeric(logLik(fit)), 2)

      tagList(
        # Coefficient table first
        div(style = "margin-bottom: 20px;",
          div(class = "segment-header", "Segment 1 (100% of sample)"),
          div(class = "segment-body",
            tableOutput("coef_table_single")
          )
        ),
        # Model fit stats row after the table
        h4("Model Fit Statistics", style = "margin-bottom: 15px;"),
        fluidRow(
          column(4, div(class = "stat-box", div(class = "stat-value", format(aic_val, big.mark = ",")), div(class = "stat-label", "AIC"))),
          column(4, div(class = "stat-box", div(class = "stat-value", format(bic_val, big.mark = ",")), div(class = "stat-label", "BIC"))),
          column(4, div(class = "stat-box", div(class = "stat-value", format(ll_val, big.mark = ",")), div(class = "stat-label", "Log-Likelihood")))
        ),
        p(style = "font-size: 0.85rem; color: #64748b; margin: 10px 0;",
          "Lower AIC/BIC values indicate better model fit. Compare models with different numbers of segments.")
      )

    } else {
      # Flexmix model - add fit stats and show coefficient tables
      fit = result$fit
      refit_mod = result$refit_model
      k = result$k
      k_requested = result$k_requested
      aic_val = round(AIC(fit), 2)
      bic_val = round(BIC(fit), 2)
      ll_val = round(as.numeric(logLik(fit)), 2)

      # Warning message if fewer segments were identified
      segment_warning = NULL
      if (k < k_requested) {
        segment_warning = div(
          style = "background: #fef3c7; border: 1px solid #f59e0b; border-radius: 8px; padding: 12px 15px; margin-bottom: 15px;",
          tags$strong(style = "color: #92400e;", "Note: "),
          span(style = "color: #78350f;",
            paste0("You requested ", k_requested, " segments, but only ", k, " segments could be identified. ",
                   "The model converged to fewer segments due to insufficient variation in the data or overlap between segments.")
          )
        )
      }

      # Build coefficient tables for each segment
      segment_tables = lapply(1:k, function(i) {
        comp_name = paste0("Comp.", i)
        coef_matrix = refit_mod@components[[1]][[comp_name]]

        # Convert to data frame
        coef_df = data.frame(
          Variable = rownames(coef_matrix),
          Estimate = round(coef_matrix[, 1], 4),
          Std.Error = round(coef_matrix[, 2], 4),
          z.value = round(coef_matrix[, 3], 4),
          P.Value = round(coef_matrix[, 4], 4)
        )

        div(style = "margin-bottom: 20px;",
          div(class = "segment-header",
            paste0("Segment ", i, " (", round(fit@prior[i] * 100, 1), "% of sample)")
          ),
          div(class = "segment-body",
            tableOutput(paste0("coef_table_seg_", i))
          )
        )
      })

      tagList(
        # Warning if fewer segments
        segment_warning,
        # Segment coefficient tables first
        segment_tables,
        # Model fit stats row after the tables
        h4("Model Fit Statistics", style = "margin-bottom: 15px;"),
        fluidRow(
          column(4, div(class = "stat-box", div(class = "stat-value", format(aic_val, big.mark = ",")), div(class = "stat-label", "AIC"))),
          column(4, div(class = "stat-box", div(class = "stat-value", format(bic_val, big.mark = ",")), div(class = "stat-label", "BIC"))),
          column(4, div(class = "stat-box", div(class = "stat-value", format(ll_val, big.mark = ",")), div(class = "stat-label", "Log-Likelihood")))
        ),
        p(style = "font-size: 0.85rem; color: #64748b; margin: 10px 0;",
          "Lower AIC/BIC values indicate better model fit. Compare models with different numbers of segments.")
      )
    }
  })

  # Single segment table (for GLM)
  output$coef_table_single = renderTable({
    result = model_result()
    if (is.null(result) || result$type != "glm") return(NULL)

    coefs = summary(result$fit)$coefficients
    data.frame(
      Variable = rownames(coefs),
      Estimate = round(coefs[, 1], 4),
      Std.Error = round(coefs[, 2], 4),
      z.value = round(coefs[, 3], 4),
      P.Value = round(coefs[, 4], 4)
    )
  }, rownames = FALSE)

  # Dynamic segment tables for flexmix
  observe({
    result = model_result()
    if (is.null(result) || result$type != "flexmix") return()

    refit_mod = result$refit_model
    k = result$k

    lapply(1:k, function(i) {
      local({
        seg_i = i
        output[[paste0("coef_table_seg_", seg_i)]] = renderTable({
          result = model_result()
          if (is.null(result) || result$type != "flexmix") return(NULL)

          comp_name = paste0("Comp.", seg_i)
          coef_matrix = result$refit_model@components[[1]][[comp_name]]

          data.frame(
            Variable = rownames(coef_matrix),
            Estimate = round(coef_matrix[, 1], 4),
            Std.Error = round(coef_matrix[, 2], 4),
            z.value = round(coef_matrix[, 3], 4),
            P.Value = round(coef_matrix[, 4], 4)
          )
        }, rownames = FALSE)
      })
    })
  })

  # Segment sizes
  output$segment_sizes = renderUI({
    result = model_result()
    if (is.null(result)) return(NULL)

    if (result$type == "glm") {
      return(
        div(style = "padding: 20px; text-align: center; color: #64748b;",
          "Only one segment (standard GLM). All observations belong to the same segment."
        )
      )
    }

    fit = result$fit
    priors = fit@prior
    k = length(priors)

    # Create a data frame for segment sizes
    size_df = data.frame(
      Segment = paste("Segment", 1:k),
      Size = paste0(round(priors * 100, 1), "%"),
      Count = paste0("~", round(priors * fit@size, 0), " obs")
    )

    tagList(
      h4("Segment Sizes", style = "margin-bottom: 15px; color: #1e293b;"),
      tableOutput("segment_size_table"),
      p(style = "margin-top: 15px; font-size: 0.9rem; color: #64748b;",
        "Segment sizes represent the prior probability of each segment (proportion of sample)."
      )
    )
  })

  # Segment size table
  output$segment_size_table = renderTable({
    result = model_result()
    if (is.null(result) || result$type != "flexmix") return(NULL)

    fit = result$fit
    priors = fit@prior
    k = length(priors)

    data.frame(
      Segment = paste("Segment", 1:k),
      Size = paste0(round(priors * 100, 1), "%"),
      Count = paste0("~", round(priors * fit@size, 0), " observations")
    )
  }, rownames = FALSE)

  # Consumer/HH assignments table
  output$consumer_assignments = renderTable({
    result = model_result()
    if (is.null(result) || is.null(result$clusters)) return(NULL)

    as.data.frame(result$clusters)
  }, rownames = FALSE)

  # R Script
  output$r_script = renderText({
    result = model_result()
    if (is.null(result)) return("")

    if (result$type == "glm") {
      # Standard GLM script
      family_str = switch(result$model_type,
        "gaussian" = "gaussian()",
        "poisson" = "poisson()",
        "binomial" = "binomial()"
      )

      script = paste0(
        "# Latent Class Regression Analysis\\n",
        "# Generated by Latent Class Regression Tool\\n\\n",
        "# Load data\\n",
        "data = read.csv(\\"your_data.csv\\")\\n\\n",
        "# Standard GLM (k = 1)\\n",
        "model = glm(\\n",
        "    ", result$dv, " ~ ", paste(result$ivs, collapse = " + "), ",\\n",
        "    data = data,\\n",
        "    family = ", family_str, "\\n",
        ")\\n\\n",
        "# View results\\n",
        "summary(model)\\n"
      )

    } else {
      # Flexmix script
      formula_str = paste(result$dv, "~", paste(result$ivs, collapse = " + "))
      if (!is.null(result$consumer_id) && result$consumer_id != "") {
        formula_str = paste(formula_str, "|", result$consumer_id)
      }

      family_str = switch(result$model_type,
        "gaussian" = '\\"gaussian\\"',
        "poisson" = '\\"poisson\\"',
        "binomial" = '\\"binomial\\"'
      )

      script = paste0(
        "# Latent Class Regression Analysis\\n",
        "# Generated by Latent Class Regression Tool\\n\\n",
        "# Install and load required packages\\n",
        "if (!require(flexmix)) install.packages(\\"flexmix\\")\\n",
        "library(flexmix)\\n\\n",
        "# Load data\\n",
        "data = read.csv(\\"your_data.csv\\")\\n\\n",
        "# Set seed for reproducibility\\n",
        "set.seed(", result$seed, ")\\n\\n",
        "# Run latent class model\\n",
        "model = stepFlexmix(\\n",
        "    ", formula_str, ",\\n",
        "    data = data,\\n",
        "    k = ", result$k, ",\\n",
        "    model = FLXMRglm(family = ", family_str, ")\\n",
        ")\\n\\n",
        "# Model fit statistics\\n",
        "cat(\\"AIC:\\", AIC(model), \\"\\\\n\\")\\n",
        "cat(\\"BIC:\\", BIC(model), \\"\\\\n\\")\\n",
        "cat(\\"Log-Likelihood:\\", logLik(model), \\"\\\\n\\\\n\\")\\n\\n",
        "# View segment sizes (prior probabilities)\\n",
        "model@prior\\n\\n",
        "# View segment-level coefficients with std. errors\\n",
        "refit_model = refit(model)\\n",
        "summary(refit_model)\\n\\n",
        "# Get segment assignments\\n",
        "clusters(model)\\n"
      )
    }

    script
  })

  # Download R script
  output$download_script = downloadHandler(
    filename = function() {
      "latent_class_regression.R"
    },
    content = function(file) {
      result = model_result()
      if (is.null(result)) return()

      # Same script generation as above but write to file
      if (result$type == "glm") {
        family_str = switch(result$model_type,
          "gaussian" = "gaussian()",
          "poisson" = "poisson()",
          "binomial" = "binomial()"
        )

        script = paste0(
          "# Latent Class Regression Analysis\\n",
          "# Generated by Latent Class Regression Tool\\n\\n",
          "data = read.csv(\\"your_data.csv\\")\\n\\n",
          "model = glm(\\n",
          "    ", result$dv, " ~ ", paste(result$ivs, collapse = " + "), ",\\n",
          "    data = data,\\n",
          "    family = ", family_str, "\\n",
          ")\\n\\n",
          "summary(model)\\n"
        )

      } else {
        formula_str = paste(result$dv, "~", paste(result$ivs, collapse = " + "))
        if (!is.null(result$consumer_id) && result$consumer_id != "") {
          formula_str = paste(formula_str, "|", result$consumer_id)
        }

        family_str = switch(result$model_type,
          "gaussian" = '\\"gaussian\\"',
          "poisson" = '\\"poisson\\"',
          "binomial" = '\\"binomial\\"'
        )

        script = paste0(
          "# Latent Class Regression Analysis\\n",
          "# Generated by Latent Class Regression Tool\\n\\n",
          "if (!require(flexmix)) install.packages(\\"flexmix\\")\\n",
          "library(flexmix)\\n\\n",
          "data = read.csv(\\"your_data.csv\\")\\n\\n",
          "set.seed(", result$seed, ")\\n\\n",
          "model = stepFlexmix(\\n",
          "    ", formula_str, ",\\n",
          "    data = data,\\n",
          "    k = ", result$k, ",\\n",
          "    model = FLXMRglm(family = ", family_str, ")\\n",
          ")\\n\\n",
          "cat(\\"AIC:\\", AIC(model), \\"\\\\n\\")\\n",
          "cat(\\"BIC:\\", BIC(model), \\"\\\\n\\")\\n\\n",
          "model@prior\\n\\n",
          "refit_model = refit(model)\\n",
          "summary(refit_model)\\n\\n",
          "clusters(model)\\n"
        )
      }

      writeLines(script, file)
    }
  )
}

shinyApp(ui = ui, server = server)
`;

            const blob = new Blob([rCode], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'Latent_Class_Regression.R';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });
    </script>

</div> <!-- end main-content -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBg3LJDwVIRGWtFZb_mM_CSRJMNCJUta20",
        authDomain: "iu-pricing-tools.firebaseapp.com",
        projectId: "iu-pricing-tools",
        storageBucket: "iu-pricing-tools.firebasestorage.app",
        messagingSenderId: "659335573790",
        appId: "1:659335573790:web:00013a166787efecb3d90f",
        measurementId: "G-NGKNY08XWP"
    };
    firebase.initializeApp(firebaseConfig);
    firebase.auth().onAuthStateChanged(function(user) {
        if (user) {
            document.getElementById('loading-screen').style.display = 'none';
            document.getElementById('main-content').style.display = 'block';
        } else {
            window.location.href = 'login.html';
        }
    });
</script>
</body>
</html>
