<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conjoint Analysis Design Tool - Setup</title>
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --success: #16a34a;
            --danger: #dc2626;
            --warning: #f59e0b;
            --bg: #f8fafc;
            --card-bg: #ffffff;
            --text-dark: #1e293b;
            --text-light: #64748b;
            --border: #e2e8f0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--bg);
            color: var(--text-dark);
            line-height: 1.6;
            padding: 1rem;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        /* Mobile responsiveness */
        @media (max-width: 600px) {
            body {
                padding: 0.75rem;
            }
            h1 {
                font-size: 1.4rem;
            }
            .subtitle {
                font-size: 0.85rem;
                margin-bottom: 1rem;
            }
            .card {
                padding: 0.875rem;
                margin-bottom: 1rem;
                overflow: hidden;
            }
            .card-title {
                font-size: 1rem;
            }
            .disclaimer {
                padding: 0.75rem;
                margin-bottom: 1rem;
            }
            .disclaimer ul {
                margin-left: 1rem;
            }
            .requirements {
                padding: 0.75rem;
                margin-bottom: 1rem;
            }
            .requirements ul {
                margin-left: 1rem;
            }
            .step {
                flex-direction: column;
                gap: 0.5rem;
            }
            .step-number {
                width: 28px;
                height: 28px;
                font-size: 0.9rem;
            }
            .step-title {
                font-size: 0.95rem;
            }
            .step-description {
                font-size: 0.85rem;
                word-wrap: break-word;
                overflow-wrap: break-word;
            }
            .step-description code {
                word-break: break-all;
                font-size: 0.75rem;
            }
            .btn {
                width: 100%;
                text-align: center;
                padding: 0.6rem 1rem;
                font-size: 0.85rem;
                word-break: break-word;
            }
            .code-block {
                font-size: 0.75rem;
                padding: 0.75rem;
                word-break: break-all;
                overflow-x: auto;
            }
            .features {
                grid-template-columns: 1fr;
            }
            .feature {
                padding: 0.75rem;
            }
            .feature-title {
                font-size: 0.9rem;
            }
            .feature-desc {
                font-size: 0.8rem;
            }
        }

        h1 {
            text-align: center;
            margin-bottom: 0.5rem;
            color: var(--text-dark);
        }

        .subtitle {
            text-align: center;
            color: var(--text-light);
            margin-bottom: 2rem;
        }

        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text-dark);
        }

        /* Disclaimer */
        .disclaimer {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            font-size: 0.9rem;
        }

        .disclaimer-title {
            font-weight: 600;
            color: #92400e;
            margin-bottom: 0.5rem;
        }

        .disclaimer ul {
            margin-left: 1.25rem;
            color: #78350f;
        }

        .disclaimer li {
            margin-bottom: 0.25rem;
        }

        /* Requirements */
        .requirements {
            background: #dbeafe;
            border: 1px solid #3b82f6;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .requirements-title {
            font-weight: 600;
            color: #1e40af;
            margin-bottom: 0.5rem;
        }

        .requirements ul {
            margin-left: 1.25rem;
            color: #1e3a8a;
        }

        /* Steps */
        .step {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid var(--border);
        }

        .step:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .step-number {
            flex-shrink: 0;
            width: 36px;
            height: 36px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .step-content {
            flex: 1;
        }

        .step-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-dark);
        }

        .step-description {
            color: var(--text-light);
            font-size: 0.95rem;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .step-description code {
            word-break: break-all;
        }

        /* Code block */
        .code-block {
            background: #1e293b;
            color: #e2e8f0;
            padding: 1rem;
            border-radius: 8px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.9rem;
            overflow-x: auto;
            margin: 0.75rem 0;
        }

        .code-block code {
            color: #4ade80;
        }

        /* Links */
        a {
            color: var(--primary);
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        /* Download button */
        .btn {
            display: inline-block;
            padding: 0.75rem 1.5rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            text-decoration: none;
            margin-top: 0.5rem;
        }

        .btn:hover {
            background: var(--primary-dark);
            text-decoration: none;
        }

        /* Features list */
        .features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .feature {
            background: var(--bg);
            padding: 1rem;
            border-radius: 8px;
        }

        .feature-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
            color: var(--text-dark);
        }

        .feature-desc {
            font-size: 0.85rem;
            color: var(--text-light);
        }

        /* Screenshot placeholder */
        .screenshot {
            background: var(--bg);
            border: 2px dashed var(--border);
            border-radius: 8px;
            padding: 3rem;
            text-align: center;
            color: var(--text-light);
            margin-top: 1rem;
        }
    </style>
</head>
<body>
<!-- Auth check -->
<div id="loading-screen" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: white; display: flex; align-items: center; justify-content: center; z-index: 9999;">
    <p style="color: #64748b;">Loading...</p>
</div>
<div id="main-content" style="display: none;">
    <div style="max-width: 800px; margin: 0 auto; padding: 0 0 10px 0;">
        <a href="tools.html" style="display: inline-flex; align-items: center; gap: 6px; color: #64748b; text-decoration: none; font-size: 0.9rem; font-weight: 500;">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
            Back to Pricing & Analytics Tools
        </a>
    </div>
    <div class="container">
        <h1>Conjoint Analysis Design Tool</h1>
        <p class="subtitle">Create fractional factorial designs for conjoint studies</p>

        <!-- Disclaimer -->
        <div class="disclaimer">
            <div class="disclaimer-title">Disclaimer</div>
            <ul>
                <li><strong>Results may contain errors.</strong> The output from this tool may be inaccurate, incomplete, or incorrect. Users should independently verify all results.</li>
                <li><strong>No warranty.</strong> This tool is provided "as is" without any warranty of any kind.</li>
                <li><strong>User assumes all risk.</strong> Users assume full responsibility for reviewing and validating any output.</li>
            </ul>
        </div>

        <!-- Requirements -->
        <div class="requirements">
            <div class="requirements-title">Requirements</div>
            <ul>
                <li><strong>R</strong> - Statistical programming language (<a href="https://cran.r-project.org/" target="_blank">Download R</a>)</li>
                <li><strong>RStudio</strong> - IDE for R (<a href="https://posit.co/download/rstudio-desktop/" target="_blank">Download RStudio</a>)</li>
            </ul>
        </div>

        <!-- Setup Instructions -->
        <div class="card">
            <div class="card-title">Setup Instructions</div>

            <div class="step">
                <div class="step-number">1</div>
                <div class="step-content">
                    <div class="step-title">Install R and RStudio</div>
                    <div class="step-description">
                        If you don't have R and RStudio installed, download and install them from the links above. Install R first, then RStudio.
                    </div>
                </div>
            </div>

            <div class="step">
                <div class="step-number">2</div>
                <div class="step-content">
                    <div class="step-title">Download and Open the App</div>
                    <div class="step-description">
                        Download the app file and open it in RStudio:
                    </div>
                    <button class="btn" id="downloadBtn">Download R App File</button>
                    <div class="step-description" style="margin-top: 0.75rem;">
                        In RStudio: File → Open File → Select the downloaded file
                    </div>
                </div>
            </div>

            <div class="step">
                <div class="step-number">3</div>
                <div class="step-content">
                    <div class="step-title">Run the App</div>
                    <div class="step-description">
                        With the file open in RStudio, click the <strong>"Run App"</strong> button in the top-right corner. The app will open in a new window or your browser.
                    </div>
                    <div class="step-description" style="margin-top: 0.5rem;">
                        <strong>Note:</strong> On first run, the app will automatically install the required R packages (<code>shiny</code> and <code>conjoint</code>). This may take a minute.
                    </div>
                </div>
            </div>
        </div>

        <!-- Features -->
        <div class="card">
            <div class="card-title">Features</div>
            <div class="features">
                <div class="feature">
                    <div class="feature-title">Add Attributes</div>
                    <div class="feature-desc">Define attributes and their levels one by one</div>
                </div>
                <div class="feature">
                    <div class="feature-title">Full Factorial Count</div>
                    <div class="feature-desc">See total combinations before reducing</div>
                </div>
                <div class="feature">
                    <div class="feature-title">Fractional Design</div>
                    <div class="feature-desc">Generate reduced profiles using R's conjoint package</div>
                </div>
                <div class="feature">
                    <div class="feature-title">Copy to Excel</div>
                    <div class="feature-desc">Profiles table ready to copy and paste</div>
                </div>
                <div class="feature">
                    <div class="feature-title">Dummy Coding</div>
                    <div class="feature-desc">View dummy-coded design matrix</div>
                </div>
                <div class="feature">
                    <div class="feature-title">R Script Export</div>
                    <div class="feature-desc">Download reproducible R script</div>
                </div>
            </div>
        </div>

        <!-- Troubleshooting -->
        <div class="card">
            <div class="card-title">Troubleshooting</div>

            <div style="margin-bottom: 1rem;">
                <strong>App doesn't open</strong>
                <div class="step-description">Make sure the R file is open in RStudio's editor (not just the file browser), then click "Run App".</div>
            </div>

            <div style="margin-bottom: 1rem;">
                <strong>Package installation fails</strong>
                <div class="step-description">Try running these commands manually in the Console:</div>
                <div class="code-block">
<code>install.packages("shiny")</code>
<code>install.packages("conjoint")</code>
                </div>
            </div>

            <div>
                <strong>"Run App" button not visible</strong>
                <div class="step-description">Make sure the file is saved with a <code>.R</code> extension. RStudio only shows the "Run App" button for R files that contain Shiny code.</div>
            </div>
        </div>
    </div>

    <script>
        document.getElementById('downloadBtn').addEventListener('click', function() {
            const rCode = `# Conjoint Analysis Design Tool - Shiny App
#
# TO RUN THIS APP:
#   1. Open this file in RStudio
#   2. Click "Run App" button (top right of editor)
#   OR run in console: shiny::runApp()

# Auto-install required packages if missing
if (!require("shiny", quietly = TRUE)) {
  install.packages("shiny", repos = "https://cloud.r-project.org")
}
if (!require("conjoint", quietly = TRUE)) {
  install.packages("conjoint", repos = "https://cloud.r-project.org")
}

library(shiny)
library(conjoint)

ui <- fluidPage(
  # Custom CSS
  tags$head(
    tags$style(HTML("
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: #f8fafc;
        padding: 20px;
      }
      .container-fluid {
        max-width: 1000px;
        margin: 0 auto;
      }
      h1 {
        text-align: center;
        color: #1e293b;
        margin-bottom: 5px;
      }
      .subtitle {
        text-align: center;
        color: #64748b;
        margin-bottom: 30px;
      }
      .card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      }
      .card-title {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 15px;
        color: #1e293b;
      }
      .btn-primary {
        background: #2563eb;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
      }
      .btn-primary:hover {
        background: #1d4ed8;
      }
      .btn-success {
        background: #16a34a;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
      }
      .btn-success:hover {
        background: #15803d;
      }
      .btn-danger {
        background: #dc2626;
        border: none;
        padding: 5px 10px;
        border-radius: 6px;
        font-size: 0.875rem;
      }
      .stat-box {
        background: #f8fafc;
        border-radius: 8px;
        padding: 15px;
        text-align: center;
        margin-bottom: 10px;
      }
      .stat-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: #2563eb;
      }
      .stat-label {
        font-size: 0.85rem;
        color: #64748b;
      }
      .attribute-item {
        background: #f8fafc;
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .attribute-name {
        font-weight: 600;
        color: #1e293b;
      }
      .attribute-levels {
        font-size: 0.9rem;
        color: #64748b;
      }
      .level-badge {
        background: #2563eb;
        color: white;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 0.75rem;
        margin-left: 8px;
      }
      .disclaimer {
        background: #fef3c7;
        border: 1px solid #f59e0b;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
        font-size: 0.9rem;
      }
      .disclaimer-title {
        font-weight: 600;
        color: #92400e;
        margin-bottom: 8px;
      }
      .disclaimer ul {
        margin-left: 20px;
        color: #78350f;
        margin-bottom: 0;
      }
      .table {
        font-size: 0.9rem;
      }
      .nav-tabs .nav-link.active {
        background: #2563eb;
        color: white;
        border: none;
      }
      .nav-tabs .nav-link {
        color: #64748b;
        border: none;
        border-radius: 6px;
        margin-right: 5px;
      }
      .help-text {
        font-size: 0.85rem;
        color: #64748b;
        margin-top: 5px;
      }
      pre.r-script {
        background: #1e293b;
        color: #e2e8f0;
        padding: 15px;
        border-radius: 8px;
        font-size: 0.85rem;
        overflow-x: auto;
      }
    "))
  ),

  # Title
  h1("Conjoint Analysis Design Tool"),
  p(class = "subtitle", "Create fractional factorial designs for conjoint studies"),

  # Disclaimer
  div(class = "disclaimer",
    div(class = "disclaimer-title", "Disclaimer"),
    tags$ul(
      tags$li(tags$strong("Results may contain errors."), " The output from this tool may be inaccurate, incomplete, or incorrect. Users should independently verify all results."),
      tags$li(tags$strong("No warranty."), " This tool is provided \\"as is\\" without any warranty of any kind."),
      tags$li(tags$strong("User assumes all risk."), " Users assume full responsibility for reviewing and validating any output.")
    )
  ),

  # Step 1: Define Attributes
  div(class = "card",
    div(class = "card-title", "1. Define Attributes"),
    fluidRow(
      column(4,
        textInput("attr_name", "Attribute Name", placeholder = "e.g., Brand")
      ),
      column(6,
        textInput("attr_levels", "Levels (comma-separated)", placeholder = "e.g., Apple, Samsung, Google, Sony")
      ),
      column(2,
        div(style = "margin-top: 25px;",
          actionButton("add_attr", "Add", class = "btn-primary")
        )
      )
    ),
    p(class = "help-text", "Enter at least 2 levels per attribute, separated by commas."),

    # Attributes list
    div(style = "margin-top: 20px;",
      uiOutput("attributes_list")
    )
  ),

  # Step 2: Design Statistics (conditional)
  uiOutput("stats_card"),

  # Step 3: Results (conditional)
  uiOutput("results_card")
)

server <- function(input, output, session) {

  # Reactive values to store attributes
  attributes <- reactiveVal(list())
  design_result <- reactiveVal(NULL)

  # Add attribute
  observeEvent(input$add_attr, {
    name <- trimws(input$attr_name)
    levels_str <- trimws(input$attr_levels)

    if (name == "") {
      showNotification("Please enter an attribute name.", type = "error")
      return()
    }

    levels <- trimws(unlist(strsplit(levels_str, ",")))
    levels <- levels[levels != ""]

    if (length(levels) < 2) {
      showNotification("Please enter at least 2 levels, separated by commas.", type = "error")
      return()
    }

    # Check for duplicates
    current <- attributes()
    if (tolower(name) %in% tolower(names(current))) {
      showNotification("An attribute with this name already exists.", type = "error")
      return()
    }

    # Add attribute
    current[[name]] <- levels
    attributes(current)

    # Clear inputs
    updateTextInput(session, "attr_name", value = "")
    updateTextInput(session, "attr_levels", value = "")

    # Clear previous design
    design_result(NULL)
  })

  # Remove attribute
  observeEvent(input$remove_attr, {
    idx <- as.integer(input$remove_attr)
    current <- attributes()
    if (idx <= length(current)) {
      current <- current[-idx]
      attributes(current)
      design_result(NULL)
    }
  })

  # Clear all
  observeEvent(input$clear_all, {
    attributes(list())
    design_result(NULL)
  })

  # Render attributes list
  output$attributes_list <- renderUI({
    attrs <- attributes()

    if (length(attrs) == 0) {
      return(div(style = "text-align: center; padding: 30px; color: #64748b;",
        "No attributes added yet. Add your first attribute above."
      ))
    }

    attr_items <- lapply(seq_along(attrs), function(i) {
      name <- names(attrs)[i]
      levels <- attrs[[i]]
      div(class = "attribute-item",
        div(
          span(class = "attribute-name", name),
          span(class = "level-badge", paste(length(levels), "levels")),
          div(class = "attribute-levels", paste(levels, collapse = ", "))
        ),
        actionButton(
          inputId = "remove_attr",
          label = "Remove",
          class = "btn-danger",
          onclick = sprintf("Shiny.setInputValue('remove_attr', %d, {priority: 'event'})", i)
        )
      )
    })

    do.call(tagList, attr_items)
  })

  # Stats card
  output$stats_card <- renderUI({
    attrs <- attributes()
    if (length(attrs) == 0) return(NULL)

    # Calculate stats
    num_attrs <- length(attrs)
    full_factorial <- prod(sapply(attrs, length))

    div(class = "card",
      div(class = "card-title", "2. Design Statistics"),
      fluidRow(
        column(4,
          div(class = "stat-box",
            div(class = "stat-value", num_attrs),
            div(class = "stat-label", "Attributes")
          )
        ),
        column(4,
          div(class = "stat-box",
            div(class = "stat-value", format(full_factorial, big.mark = ",")),
            div(class = "stat-label", "Full Factorial Profiles")
          )
        ),
        column(4,
          div(class = "stat-box",
            div(class = "stat-value",
              if (!is.null(design_result())) nrow(design_result()$profiles) else "-"
            ),
            div(class = "stat-label", "Fractional Design Profiles")
          )
        )
      ),
      div(style = "margin-top: 15px;",
        actionButton("generate", "Generate Fractional Design", class = "btn-success"),
        actionButton("clear_all", "Clear All Attributes", class = "btn-secondary", style = "margin-left: 10px;")
      )
    )
  })

  # Generate design
  observeEvent(input$generate, {
    attrs <- attributes()

    if (length(attrs) < 2) {
      showNotification("Please add at least 2 attributes.", type = "error")
      return()
    }

    tryCatch({
      # Create full factorial
      fullprofiles <- expand.grid(attrs, stringsAsFactors = FALSE)

      # Generate fractional design
      reducedprofiles <- caFactorialDesign(data = fullprofiles, type = "fractional")

      # Store result
      design_result(list(
        profiles = reducedprofiles,
        attributes = attrs
      ))

      showNotification(
        paste("Design generated with", nrow(reducedprofiles), "profiles."),
        type = "message"
      )

    }, error = function(e) {
      showNotification(paste("Error:", e$message), type = "error")
    })
  })

  # Results card
  output$results_card <- renderUI({
    result <- design_result()
    if (is.null(result)) return(NULL)

    div(class = "card",
      div(class = "card-title", "3. Design Profiles"),
      tabsetPanel(
        tabPanel("Profiles",
          div(style = "margin-top: 15px;",
            tableOutput("profiles_table"),
            p(style = "font-size: 0.85rem; color: #64748b; font-style: italic;",
              "Select the table and copy (Ctrl+C / Cmd+C) to paste into Excel.")
          )
        ),
        tabPanel("Dummy Coded",
          div(style = "margin-top: 15px;",
            tableOutput("dummy_table"),
            p(style = "font-size: 0.85rem; color: #64748b; font-style: italic;",
              "Reference levels (first level of each attribute) are omitted.")
          )
        ),
        tabPanel("R Script",
          div(style = "margin-top: 15px;",
            p(style = "color: #64748b;", "Use this R script to reproduce the design:"),
            verbatimTextOutput("r_script"),
            downloadButton("download_script", "Download R Script", class = "btn-secondary")
          )
        )
      )
    )
  })

  # Profiles table
  output$profiles_table <- renderTable({
    result <- design_result()
    if (is.null(result)) return(NULL)

    profiles <- result$profiles
    profiles <- cbind(Profile = 1:nrow(profiles), profiles)
    profiles
  }, rownames = FALSE)

  # Dummy coded table
  output$dummy_table <- renderTable({
    result <- design_result()
    if (is.null(result)) return(NULL)

    profiles <- result$profiles
    attrs <- result$attributes

    # Create dummy variables
    dummy_df <- data.frame(Profile = 1:nrow(profiles))

    for (attr_name in names(attrs)) {
      levels <- attrs[[attr_name]]
      # Skip first level (reference)
      for (i in 2:length(levels)) {
        col_name <- paste0(attr_name, "_", gsub(" ", "_", levels[i]))
        dummy_df[[col_name]] <- as.integer(profiles[[attr_name]] == levels[i])
      }
    }

    dummy_df
  }, rownames = FALSE)

  # R Script
  output$r_script <- renderText({
    result <- design_result()
    if (is.null(result)) return("")

    attrs <- result$attributes

    # Build attribute definitions
    attr_defs <- sapply(names(attrs), function(name) {
      clean_name <- gsub(" ", "_", name)
      levels_str <- paste0('"', attrs[[name]], '"', collapse = ", ")
      paste0(clean_name, " = c(", levels_str, ")")
    })

    attr_names <- gsub(" ", "_", names(attrs))

    script <- paste0(
      "# Conjoint Analysis Fractional Factorial Design\\n",
      "# Generated by Conjoint Design Tool\\n\\n",
      "# Install and load required packages\\n",
      "if (!require(conjoint)) install.packages(\\"conjoint\\")\\n",
      "library(conjoint)\\n\\n",
      "# Define attributes and levels\\n",
      paste(attr_defs, collapse = "\\n"), "\\n\\n",
      "# Create full factorial profiles\\n",
      "fullprofiles = expand.grid(", paste(attr_names, collapse = ", "), ")\\n\\n",
      "# Generate fractional factorial design\\n",
      "reducedprofiles = caFactorialDesign(data = fullprofiles, type = \\"fractional\\")\\n\\n",
      "# View the design\\n",
      "print(reducedprofiles)\\n\\n",
      "# Number of profiles\\n",
      "cat(\\"Number of profiles:\\", nrow(reducedprofiles), \\"\\\\n\\")\\n"
    )

    script
  })

  # Download R script
  output$download_script <- downloadHandler(
    filename = function() {
      "conjoint_design.R"
    },
    content = function(file) {
      result <- design_result()
      if (is.null(result)) return()

      attrs <- result$attributes

      attr_defs <- sapply(names(attrs), function(name) {
        clean_name <- gsub(" ", "_", name)
        levels_str <- paste0('"', attrs[[name]], '"', collapse = ", ")
        paste0(clean_name, " = c(", levels_str, ")")
      })

      attr_names <- gsub(" ", "_", names(attrs))

      script <- paste0(
        "# Conjoint Analysis Fractional Factorial Design\\n",
        "# Generated by Conjoint Design Tool\\n\\n",
        "if (!require(conjoint)) install.packages(\\"conjoint\\")\\n",
        "library(conjoint)\\n\\n",
        paste(attr_defs, collapse = "\\n"), "\\n\\n",
        "fullprofiles = expand.grid(", paste(attr_names, collapse = ", "), ")\\n\\n",
        "reducedprofiles = caFactorialDesign(data = fullprofiles, type = \\"fractional\\")\\n\\n",
        "print(reducedprofiles)\\n",
        "cat(\\"Number of profiles:\\", nrow(reducedprofiles), \\"\\\\n\\")\\n"
      )

      writeLines(script, file)
    }
  )
}

shinyApp(ui = ui, server = server)
`;

            const blob = new Blob([rCode], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'Conjoint_Fractional_Factorial_Design.R';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });
    </script>

</div> <!-- end main-content -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBg3LJDwVIRGWtFZb_mM_CSRJMNCJUta20",
        authDomain: "iu-pricing-tools.firebaseapp.com",
        projectId: "iu-pricing-tools",
        storageBucket: "iu-pricing-tools.firebasestorage.app",
        messagingSenderId: "659335573790",
        appId: "1:659335573790:web:00013a166787efecb3d90f",
        measurementId: "G-NGKNY08XWP"
    };
    firebase.initializeApp(firebaseConfig);
    firebase.auth().onAuthStateChanged(function(user) {
        if (user) {
            document.getElementById('loading-screen').style.display = 'none';
            document.getElementById('main-content').style.display = 'block';
        } else {
            window.location.href = 'login.html';
        }
    });
</script>
</body>
</html>
